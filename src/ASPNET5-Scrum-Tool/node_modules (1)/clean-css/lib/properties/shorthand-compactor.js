var compactable = require('./compactable');
var deepClone = require('./clone').deep;
var hasInherit = require('./has-inherit');
var populateComponents = require('./populate-components');
var wrapSingle = require('./wrap-for-optimizing').single;
var everyCombination = require('./every-combination');

function mixedImportance(components) ***REMOVED***
  var important;

  for (var name in components) ***REMOVED***
    if (undefined !== important && components[name].important != important)
      return true;

    important = components[name].important;
  ***REMOVED***

  return false;
***REMOVED***

function componentSourceMaps(components) ***REMOVED***
  var sourceMapping = [];

  for (var name in components) ***REMOVED***
    var component = components[name];
    var originalValue = component.all[component.position];
    var mapping = originalValue[0][originalValue[0].length - 1];

    if (Array.isArray(mapping))
      Array.prototype.push.apply(sourceMapping, mapping);
  ***REMOVED***

  return sourceMapping;
***REMOVED***

function replaceWithShorthand(properties, candidateComponents, name, sourceMaps, validator) ***REMOVED***
  var descriptor = compactable[name];
  var newValuePlaceholder = [[name], [descriptor.defaultValue]];
  var all;

  var newProperty = wrapSingle(newValuePlaceholder);
  newProperty.shorthand = true;
  newProperty.dirty = true;

  populateComponents([newProperty], validator);

  for (var i = 0, l = descriptor.components.length; i < l; i++) ***REMOVED***
    var component = candidateComponents[descriptor.components[i]];
    var canOverride = compactable[component.name].canOverride;

    if (hasInherit(component))
      return;

    if (!everyCombination(canOverride, newProperty.components[i], component, validator))
      return;

    newProperty.components[i] = deepClone(component);
    newProperty.important = component.important;

    all = component.all;
  ***REMOVED***

  for (var componentName in candidateComponents) ***REMOVED***
    candidateComponents[componentName].unused = true;
  ***REMOVED***

  if (sourceMaps) ***REMOVED***
    var sourceMapping = componentSourceMaps(candidateComponents);
    if (sourceMapping.length > 0)
      newValuePlaceholder[0].push(sourceMapping);
  ***REMOVED***

  newProperty.position = all.length;
  newProperty.all = all;
  newProperty.all.push(newValuePlaceholder);

  properties.push(newProperty);
***REMOVED***

function invalidateOrCompact(properties, position, candidates, sourceMaps, validator) ***REMOVED***
  var property = properties[position];

  for (var name in candidates) ***REMOVED***
    if (undefined !== property && name == property.name)
      continue;

    var descriptor = compactable[name];
    var candidateComponents = candidates[name];
    if (descriptor.components.length > Object.keys(candidateComponents).length) ***REMOVED***
      delete candidates[name];
      continue;
***REMOVED***

    if (mixedImportance(candidateComponents))
      continue;

    replaceWithShorthand(properties, candidateComponents, name, sourceMaps, validator);
  ***REMOVED***
***REMOVED***

function compactShortands(properties, sourceMaps, validator) ***REMOVED***
  var candidates = ***REMOVED******REMOVED***;

  if (properties.length < 3)
    return;

  for (var i = 0, l = properties.length; i < l; i++) ***REMOVED***
    var property = properties[i];
    if (property.unused)
      continue;

    if (property.hack)
      continue;

    if (property.variable)
      continue;

    var descriptor = compactable[property.name];
    if (!descriptor || !descriptor.componentOf)
      continue;

    if (property.shorthand) ***REMOVED***
      invalidateOrCompact(properties, i, candidates, sourceMaps, validator);
***REMOVED*** else ***REMOVED***
      var componentOf = descriptor.componentOf;
      candidates[componentOf] = candidates[componentOf] || ***REMOVED******REMOVED***;
      candidates[componentOf][property.name] = property;
***REMOVED***
  ***REMOVED***

  invalidateOrCompact(properties, i, candidates, sourceMaps, validator);
***REMOVED***

module.exports = compactShortands;
