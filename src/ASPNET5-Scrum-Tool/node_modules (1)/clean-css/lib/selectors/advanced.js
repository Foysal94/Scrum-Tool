var optimizeProperties = require('../properties/optimizer');

var removeDuplicates = require('./remove-duplicates');
var mergeAdjacent = require('./merge-adjacent');
var reduceNonAdjacent = require('./reduce-non-adjacent');
var mergeNonAdjacentBySelector = require('./merge-non-adjacent-by-selector');
var mergeNonAdjacentByBody = require('./merge-non-adjacent-by-body');
var restructure = require('./restructure');
var removeDuplicateMediaQueries = require('./remove-duplicate-media-queries');
var mergeMediaQueries = require('./merge-media-queries');

function removeEmpty(tokens) ***REMOVED***
  for (var i = 0, l = tokens.length; i < l; i++) ***REMOVED***
    var token = tokens[i];
    var isEmpty = false;

    switch (token[0]) ***REMOVED***
      case 'selector':
        isEmpty = token[1].length === 0 || token[2].length === 0;
        break;
      case 'block':
        removeEmpty(token[2]);
        isEmpty = token[2].length === 0;
***REMOVED***

    if (isEmpty) ***REMOVED***
      tokens.splice(i, 1);
      i--;
      l--;
***REMOVED***
  ***REMOVED***
***REMOVED***

function recursivelyOptimizeBlocks(tokens, options, validator) ***REMOVED***
  for (var i = 0, l = tokens.length; i < l; i++) ***REMOVED***
    var token = tokens[i];

    if (token[0] == 'block') ***REMOVED***
      var isKeyframes = /@(-moz-|-o-|-webkit-)?keyframes/.test(token[1][0]);
      optimize(token[2], options, validator, !isKeyframes);
***REMOVED***
  ***REMOVED***
***REMOVED***

function recursivelyOptimizeProperties(tokens, options, validator) ***REMOVED***
  for (var i = 0, l = tokens.length; i < l; i++) ***REMOVED***
    var token = tokens[i];

    switch (token[0]) ***REMOVED***
      case 'selector':
        optimizeProperties(token[1], token[2], false, true, options, validator);
        break;
      case 'block':
        recursivelyOptimizeProperties(token[2], options, validator);
***REMOVED***
  ***REMOVED***
***REMOVED***

function optimize(tokens, options, validator, withRestructuring) ***REMOVED***
  recursivelyOptimizeBlocks(tokens, options, validator);
  recursivelyOptimizeProperties(tokens, options, validator);

  removeDuplicates(tokens);
  mergeAdjacent(tokens, options, validator);
  reduceNonAdjacent(tokens, options, validator);

  mergeNonAdjacentBySelector(tokens, options, validator);
  mergeNonAdjacentByBody(tokens, options);

  if (options.restructuring && withRestructuring) ***REMOVED***
    restructure(tokens, options);
    mergeAdjacent(tokens, options, validator);
  ***REMOVED***

  if (options.mediaMerging) ***REMOVED***
    removeDuplicateMediaQueries(tokens);
    var reduced = mergeMediaQueries(tokens);
    for (var i = reduced.length - 1; i >= 0; i--) ***REMOVED***
      optimize(reduced[i][2], options, validator, false);
***REMOVED***
  ***REMOVED***

  removeEmpty(tokens);
***REMOVED***

module.exports = optimize;
