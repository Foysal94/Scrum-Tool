var SourceMapGenerator = require('source-map').SourceMapGenerator;
var all = require('./helpers').all;

var isWindows = process.platform == 'win32';
var unknownSource = '$stdin';

function store(element, context) ***REMOVED***
  var fromString = typeof element == 'string';
  var value = fromString ? element : element[0];

  if (value.indexOf('_') > -1)
    value = context.restore(value, prefixContentFrom(context.output));

  track(value, fromString ? null : element, context);
  context.output.push(value);
***REMOVED***

function prefixContentFrom(values) ***REMOVED***
  var content = [];

  for (var i = values.length - 1; i >= 0; i--) ***REMOVED***
    var value = values[i];
    content.unshift(value);

    if (value == '***REMOVED***' || value == ';')
      break;
  ***REMOVED***

  return content.join('');
***REMOVED***

function track(value, element, context) ***REMOVED***
  if (element)
    trackAllMappings(element, context);

  var parts = value.split('\n');
  context.line += parts.length - 1;
  context.column = parts.length > 1 ? 0 : (context.column + parts.pop().length);
***REMOVED***

function trackAllMappings(element, context) ***REMOVED***
  var mapping = element[element.length - 1];

  if (!Array.isArray(mapping))
    return;

  for (var i = 0, l = mapping.length; i < l; i++) ***REMOVED***
    trackMapping(mapping[i], context);
  ***REMOVED***
***REMOVED***

function trackMapping(mapping, context) ***REMOVED***
  var source = mapping[2] || unknownSource;

  if (isWindows)
    source = source.replace(/\\/g, '/');

  context.outputMap.addMapping(***REMOVED***
    generated: ***REMOVED***
      line: context.line,
      column: context.column
***REMOVED***,
    source: source,
    original: ***REMOVED***
      line: mapping[0],
      column: mapping[1]
***REMOVED***
  ***REMOVED***);

  if (mapping[3])
    context.outputMap.setSourceContent(source, mapping[3][mapping[2]]);
***REMOVED***

function stringify(tokens, options, restoreCallback, inputMapTracker) ***REMOVED***
  var context = ***REMOVED***
    column: 0,
    inputMapTracker: inputMapTracker,
    keepBreaks: options.keepBreaks,
    line: 1,
    output: [],
    outputMap: new SourceMapGenerator(),
    restore: restoreCallback,
    sourceMapInlineSources: options.sourceMapInlineSources,
    spaceAfterClosingBrace: options.compatibility.properties.spaceAfterClosingBrace,
    store: store
  ***REMOVED***;

  all(tokens, context, false);

  return ***REMOVED***
    sourceMap: context.outputMap,
    styles: context.output.join('').trim()
  ***REMOVED***;
***REMOVED***

module.exports = stringify;
