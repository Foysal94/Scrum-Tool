var placeholderBrace = '__';

function EscapeStore(placeholderRoot) ***REMOVED***
  this.placeholderRoot = 'ESCAPED_' + placeholderRoot + '_CLEAN_CSS';
  this.placeholderToData = ***REMOVED******REMOVED***;
  this.dataToPlaceholder = ***REMOVED******REMOVED***;
  this.count = 0;
  this.restoreMatcher = new RegExp(this.placeholderRoot + '(\\d+)');
***REMOVED***

EscapeStore.prototype._nextPlaceholder = function (metadata) ***REMOVED***
  return ***REMOVED***
    index: this.count,
    value: placeholderBrace + this.placeholderRoot + this.count++ + metadata + placeholderBrace
  ***REMOVED***;
***REMOVED***;

EscapeStore.prototype.store = function (data, metadata) ***REMOVED***
  var encodedMetadata = metadata ?
    '(' + metadata.join(',') + ')' :
    '';
  var placeholder = this.dataToPlaceholder[data];

  if (!placeholder) ***REMOVED***
    var nextPlaceholder = this._nextPlaceholder(encodedMetadata);
    placeholder = nextPlaceholder.value;
    this.placeholderToData[nextPlaceholder.index] = data;
    this.dataToPlaceholder[data] = nextPlaceholder.value;
  ***REMOVED***

  if (metadata)
    placeholder = placeholder.replace(/\([^\)]+\)/, encodedMetadata);

  return placeholder;
***REMOVED***;

EscapeStore.prototype.nextMatch = function (data, cursor) ***REMOVED***
  var next = ***REMOVED******REMOVED***;

  next.start = data.indexOf(this.placeholderRoot, cursor) - placeholderBrace.length;
  next.end = data.indexOf(placeholderBrace, next.start + placeholderBrace.length) + placeholderBrace.length;
  if (next.start > -1 && next.end > -1)
    next.match = data.substring(next.start, next.end);

  return next;
***REMOVED***;

EscapeStore.prototype.restore = function (placeholder) ***REMOVED***
  var index = this.restoreMatcher.exec(placeholder)[1];
  return this.placeholderToData[index];
***REMOVED***;

module.exports = EscapeStore;
