var EscapeStore = require('./escape-store');

var EXPRESSION_NAME = 'expression';
var EXPRESSION_START = '(';
var EXPRESSION_END = ')';
var EXPRESSION_PREFIX = EXPRESSION_NAME + EXPRESSION_START;
var BODY_START = '***REMOVED***';
var BODY_END = '***REMOVED***';

var lineBreak = require('os').EOL;

function findEnd(data, start) ***REMOVED***
  var end = start + EXPRESSION_NAME.length;
  var level = 0;
  var quoted = false;
  var braced = false;

  while (true) ***REMOVED***
    var current = data[end++];

    if (quoted) ***REMOVED***
      quoted = current != '\'' && current != '"';
***REMOVED*** else ***REMOVED***
      quoted = current == '\'' || current == '"';

      if (current == EXPRESSION_START)
        level++;
      if (current == EXPRESSION_END)
        level--;
      if (current == BODY_START)
        braced = true;
      if (current == BODY_END && !braced && level == 1) ***REMOVED***
        end--;
        level--;
  ***REMOVED***
***REMOVED***

    if (level === 0 && current == EXPRESSION_END)
      break;
    if (!current) ***REMOVED***
      end = data.substring(0, end).lastIndexOf(BODY_END);
      break;
***REMOVED***
  ***REMOVED***

  return end;
***REMOVED***

function ExpressionsProcessor(saveWaypoints) ***REMOVED***
  this.expressions = new EscapeStore('EXPRESSION');
  this.saveWaypoints = saveWaypoints;
***REMOVED***

ExpressionsProcessor.prototype.escape = function (data) ***REMOVED***
  var nextStart = 0;
  var nextEnd = 0;
  var cursor = 0;
  var tempData = [];
  var indent = 0;
  var breaksCount;
  var lastBreakAt;
  var newIndent;
  var saveWaypoints = this.saveWaypoints;

  for (; nextEnd < data.length;) ***REMOVED***
    nextStart = data.indexOf(EXPRESSION_PREFIX, nextEnd);
    if (nextStart == -1)
      break;

    nextEnd = findEnd(data, nextStart);

    var expression = data.substring(nextStart, nextEnd);
    if (saveWaypoints) ***REMOVED***
      breaksCount = expression.split(lineBreak).length - 1;
      lastBreakAt = expression.lastIndexOf(lineBreak);
      newIndent = lastBreakAt > 0 ?
        expression.substring(lastBreakAt + lineBreak.length).length :
        indent + expression.length;
***REMOVED***

    var metadata = saveWaypoints ? [breaksCount, newIndent] : null;
    var placeholder = this.expressions.store(expression, metadata);
    tempData.push(data.substring(cursor, nextStart));
    tempData.push(placeholder);

    if (saveWaypoints)
      indent = newIndent + 1;
    cursor = nextEnd;
  ***REMOVED***

  return tempData.length > 0 ?
    tempData.join('') + data.substring(cursor, data.length) :
    data;
***REMOVED***;

ExpressionsProcessor.prototype.restore = function (data) ***REMOVED***
  var tempData = [];
  var cursor = 0;

  for (; cursor < data.length;) ***REMOVED***
    var nextMatch = this.expressions.nextMatch(data, cursor);
    if (nextMatch.start < 0)
      break;

    tempData.push(data.substring(cursor, nextMatch.start));
    var comment = this.expressions.restore(nextMatch.match);
    tempData.push(comment);

    cursor = nextMatch.end;
  ***REMOVED***

  return tempData.length > 0 ?
    tempData.join('') + data.substring(cursor, data.length) :
    data;
***REMOVED***;

module.exports = ExpressionsProcessor;
