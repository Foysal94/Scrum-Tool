var path = require('path');
var url = require('url');

var reduceUrls = require('./reduce');

var isWindows = process.platform == 'win32';

function isAbsolute(uri) ***REMOVED***
  return uri[0] == '/';
***REMOVED***

function isSVGMarker(uri) ***REMOVED***
  return uri[0] == '#';
***REMOVED***

function isEscaped(uri) ***REMOVED***
  return uri.indexOf('__ESCAPED_URL_CLEAN_CSS__') === 0;
***REMOVED***

function isInternal(uri) ***REMOVED***
  return /^\w+:\w+/.test(uri);
***REMOVED***

function isRemote(uri) ***REMOVED***
  return /^[^:]+?:\/\//.test(uri) || uri.indexOf('//') === 0;
***REMOVED***

function isSameOrigin(uri1, uri2) ***REMOVED***
  return url.parse(uri1).protocol == url.parse(uri2).protocol &&
    url.parse(uri1).host == url.parse(uri2).host;
***REMOVED***

function isImport(uri) ***REMOVED***
  return uri.lastIndexOf('.css') === uri.length - 4;
***REMOVED***

function isData(uri) ***REMOVED***
  return uri.indexOf('data:') === 0;
***REMOVED***

function absolute(uri, options) ***REMOVED***
  return path
    .resolve(path.join(options.fromBase || '', uri))
    .replace(options.toBase, '');
***REMOVED***

function relative(uri, options) ***REMOVED***
  return path.relative(options.toBase, path.join(options.fromBase || '', uri));
***REMOVED***

function normalize(uri) ***REMOVED***
  return isWindows ? uri.replace(/\\/g, '/') : uri;
***REMOVED***

function rebase(uri, options) ***REMOVED***
  if (isAbsolute(uri) || isSVGMarker(uri) || isEscaped(uri) || isInternal(uri))
    return uri;

  if (options.rebase === false && !isImport(uri))
    return uri;

  if (!options.imports && isImport(uri))
    return uri;

  if (isData(uri))
    return '\'' + uri + '\'';

  if (isRemote(uri) && !isRemote(options.toBase))
    return uri;

  if (isRemote(uri) && !isSameOrigin(uri, options.toBase))
    return uri;

  if (!isRemote(uri) && isRemote(options.toBase))
    return url.resolve(options.toBase, uri);

  return options.absolute ?
    normalize(absolute(uri, options)) :
    normalize(relative(uri, options));
***REMOVED***

function quoteFor(url) ***REMOVED***
  if (url.indexOf('\'') > -1)
    return '"';
  else if (url.indexOf('"') > -1)
    return '\'';
  else if (/\s/.test(url) || /[\(\)]/.test(url))
    return '\'';
  else
    return '';
***REMOVED***

function rewriteUrls(data, options, context) ***REMOVED***
  return reduceUrls(data, context, function (originUrl, tempData) ***REMOVED***
    var url = originUrl.replace(/^(url\()?\s*['"]?|['"]?\s*\)?$/g, '');
    var match = originUrl.match(/^(url\()?\s*(['"]).*?(['"])\s*\)?$/);
    var quote;
    if (!!options.urlQuotes && match && match[2] === match[3]) ***REMOVED***
      quote = match[2];
***REMOVED*** else ***REMOVED***
      quote = quoteFor(url);
***REMOVED***
    tempData.push('url(' + quote + rebase(url, options) + quote + ')');
  ***REMOVED***);
***REMOVED***

module.exports = rewriteUrls;
