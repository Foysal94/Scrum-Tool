function QuoteScanner(data) ***REMOVED***
  this.data = data;
***REMOVED***

var findQuoteEnd = function (data, matched, cursor, oldCursor) ***REMOVED***
  var commentStartMark = '/*';
  var commentEndMark = '*/';
  var escapeMark = '\\';
  var blockEndMark = '***REMOVED***';
  var dataPrefix = data.substring(oldCursor, cursor);
  var commentEndedAt = dataPrefix.lastIndexOf(commentEndMark, cursor);
  var commentStartedAt = dataPrefix.lastIndexOf(commentStartMark, cursor);
  var commentStarted = false;

  if (commentEndedAt >= cursor && commentStartedAt > -1)
    commentStarted = true;
  if (commentStartedAt < cursor && commentStartedAt > commentEndedAt)
    commentStarted = true;

  if (commentStarted) ***REMOVED***
    var commentEndsAt = data.indexOf(commentEndMark, cursor);
    if (commentEndsAt > -1)
      return commentEndsAt;

    commentEndsAt = data.indexOf(blockEndMark, cursor);
    return commentEndsAt > -1 ? commentEndsAt - 1 : data.length;
  ***REMOVED***

  while (true) ***REMOVED***
    if (data[cursor] === undefined)
      break;
    if (data[cursor] == matched && (data[cursor - 1] != escapeMark || data[cursor - 2] == escapeMark))
      break;

    cursor++;
  ***REMOVED***

  return cursor;
***REMOVED***;

function findNext(data, mark, startAt) ***REMOVED***
  var escapeMark = '\\';
  var candidate = startAt;

  while (true) ***REMOVED***
    candidate = data.indexOf(mark, candidate + 1);
    if (candidate == -1)
      return -1;
    if (data[candidate - 1] != escapeMark)
      return candidate;
  ***REMOVED***
***REMOVED***

QuoteScanner.prototype.each = function (callback) ***REMOVED***
  var data = this.data;
  var tempData = [];
  var nextStart = 0;
  var nextEnd = 0;
  var cursor = 0;
  var matchedMark = null;
  var singleMark = '\'';
  var doubleMark = '"';
  var dataLength = data.length;

  for (; nextEnd < data.length;) ***REMOVED***
    var nextStartSingle = findNext(data, singleMark, nextEnd);
    var nextStartDouble = findNext(data, doubleMark, nextEnd);

    if (nextStartSingle == -1)
      nextStartSingle = dataLength;
    if (nextStartDouble == -1)
      nextStartDouble = dataLength;

    if (nextStartSingle < nextStartDouble) ***REMOVED***
      nextStart = nextStartSingle;
      matchedMark = singleMark;
***REMOVED*** else ***REMOVED***
      nextStart = nextStartDouble;
      matchedMark = doubleMark;
***REMOVED***

    if (nextStart == -1)
      break;

    nextEnd = findQuoteEnd(data, matchedMark, nextStart + 1, cursor);
    if (nextEnd == -1)
      break;

    var text = data.substring(nextStart, nextEnd + 1);
    tempData.push(data.substring(cursor, nextStart));
    if (text.length > 0)
      callback(text, tempData, nextStart);

    cursor = nextEnd + 1;
  ***REMOVED***

  return tempData.length > 0 ?
    tempData.join('') + data.substring(cursor, data.length) :
    data;
***REMOVED***;

module.exports = QuoteScanner;
