var path = require('path');
var rewriteUrls = require('../urls/rewrite');

var REMOTE_RESOURCE = /^(https?:)?\/\//;

function SourceReader(context, data) ***REMOVED***
  this.outerContext = context;
  this.data = data;
  this.sources = ***REMOVED******REMOVED***;
***REMOVED***

SourceReader.prototype.sourceAt = function (path) ***REMOVED***
  return this.sources[path];
***REMOVED***;

SourceReader.prototype.trackSource = function (path, source) ***REMOVED***
  this.sources[path] = ***REMOVED******REMOVED***;
  this.sources[path][path] = source;
***REMOVED***;

SourceReader.prototype.toString = function () ***REMOVED***
  if (typeof this.data == 'string')
    return fromString(this);
  if (Buffer.isBuffer(this.data))
    return fromBuffer(this);
  if (Array.isArray(this.data))
    return fromArray(this);

  return fromHash(this);
***REMOVED***;

function fromString(self) ***REMOVED***
  var data = self.data;
  self.trackSource(undefined, data);
  return data;
***REMOVED***

function fromBuffer(self) ***REMOVED***
  var data = self.data.toString();
  self.trackSource(undefined, data);
  return data;
***REMOVED***

function fromArray(self) ***REMOVED***
  return self.data
    .map(function (source) ***REMOVED***
      return self.outerContext.options.processImport === false ?
        source + '@shallow' :
        source;
***REMOVED***)
    .map(function (source) ***REMOVED***
      return !self.outerContext.options.relativeTo || /^https?:\/\//.test(source) ?
        source :
        path.relative(self.outerContext.options.relativeTo, source);
***REMOVED***)
    .map(function (source) ***REMOVED*** return '@import url(' + source + ');'; ***REMOVED***)
    .join('');
***REMOVED***

function fromHash(self) ***REMOVED***
  var data = [];
  var toBase = path.resolve(self.outerContext.options.target || self.outerContext.options.root);

  for (var source in self.data) ***REMOVED***
    var styles = self.data[source].styles;
    var inputSourceMap = self.data[source].sourceMap;
    var isRemote = REMOTE_RESOURCE.test(source);
    var absoluteSource = isRemote ? source : path.resolve(source);
    var absoluteSourcePath = path.dirname(absoluteSource);

    var rewriteOptions = ***REMOVED***
      absolute: self.outerContext.options.explicitRoot,
      relative: !self.outerContext.options.explicitRoot,
      imports: true,
      rebase: self.outerContext.options.rebase,
      fromBase: absoluteSourcePath,
      toBase: isRemote ? absoluteSourcePath : toBase,
      urlQuotes: self.outerContext.options.compatibility.properties.urlQuotes
***REMOVED***;
    styles = rewriteUrls(styles, rewriteOptions, self.outerContext);

    self.trackSource(source, styles);

    styles = self.outerContext.sourceTracker.store(source, styles);

    // here we assume source map lies in the same directory as `source` does
    if (self.outerContext.options.sourceMap && inputSourceMap)
      self.outerContext.inputSourceMapTracker.trackLoaded(source, source, inputSourceMap);

    data.push(styles);
  ***REMOVED***

  return data.join('');
***REMOVED***

module.exports = SourceReader;
