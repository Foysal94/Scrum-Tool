
/**
 * Module exports.
 */

module.exports = exports = gyp

/**
 * Module dependencies.
 */

var fs = require('graceful-fs')
  , path = require('path')
  , nopt = require('nopt')
  , log = require('npmlog')
  , child_process = require('child_process')
  , EE = require('events').EventEmitter
  , inherits = require('util').inherits
  , commands = [
      // Module build commands
        'build'
      , 'clean'
      , 'configure'
      , 'rebuild'
      // Development Header File management commands
      , 'install'
      , 'list'
      , 'remove'
    ]
  , aliases = ***REMOVED***
        'ls': 'list'
      , 'rm': 'remove'
***REMOVED***

// differentiate node-gyp's logs from npm's
log.heading = 'gyp'

/**
 * The `gyp` function.
 */

function gyp () ***REMOVED***
  return new Gyp()
***REMOVED***

function Gyp () ***REMOVED***
  var self = this

  // set the dir where node-gyp dev files get installed
  // TODO: make this *more* configurable?
  //       see: https://github.com/nodejs/node-gyp/issues/21
  var homeDir = process.env.HOME || process.env.USERPROFILE
  if (!homeDir) ***REMOVED***
    throw new Error(
      "node-gyp requires that the user's home directory is specified " +
      "in either of the environmental variables HOME or USERPROFILE"
    );
  ***REMOVED***
  this.devDir = path.resolve(homeDir, '.node-gyp')

  this.commands = ***REMOVED******REMOVED***

  commands.forEach(function (command) ***REMOVED***
    self.commands[command] = function (argv, callback) ***REMOVED***
      log.verbose('command', command, argv)
      return require('./' + command)(self, argv, callback)
***REMOVED***
  ***REMOVED***)
***REMOVED***
inherits(Gyp, EE)
exports.Gyp = Gyp
var proto = Gyp.prototype

/**
 * Export the contents of the package.json.
 */

proto.package = require('../package')

/**
 * nopt configuration definitions
 */

proto.configDefs = ***REMOVED***
    help: Boolean     // everywhere
  , arch: String      // 'configure'
  , debug: Boolean    // 'build'
  , directory: String // bin
  , make: String      // 'build'
  , msvs_version: String // 'configure'
  , ensure: Boolean   // 'install'
  , solution: String  // 'build' (windows only)
  , proxy: String     // 'install'
  , nodedir: String   // 'configure'
  , loglevel: String  // everywhere
  , python: String    // 'configure'
  , 'dist-url': String // 'install'
  , 'tarball': String // 'install'
  , jobs: String      // 'build'
  , thin: String      // 'configure'
***REMOVED***

/**
 * nopt shorthands
 */

proto.shorthands = ***REMOVED***
    release: '--no-debug'
  , C: '--directory'
  , debug: '--debug'
  , j: '--jobs'
  , silly: '--loglevel=silly'
  , verbose: '--loglevel=verbose'
***REMOVED***

/**
 * expose the command aliases for the bin file to use.
 */

proto.aliases = aliases

/**
 * Parses the given argv array and sets the 'opts',
 * 'argv' and 'command' properties.
 */

proto.parseArgv = function parseOpts (argv) ***REMOVED***
  this.opts = nopt(this.configDefs, this.shorthands, argv)
  this.argv = this.opts.argv.remain.slice()

  var commands = this.todo = []

  // create a copy of the argv array with aliases mapped
  argv = this.argv.map(function (arg) ***REMOVED***
    // is this an alias?
    if (arg in this.aliases) ***REMOVED***
      arg = this.aliases[arg]
***REMOVED***
    return arg
  ***REMOVED***, this)

  // process the mapped args into "command" objects ("name" and "args" props)
  argv.slice().forEach(function (arg) ***REMOVED***
    if (arg in this.commands) ***REMOVED***
      var args = argv.splice(0, argv.indexOf(arg))
      argv.shift()
      if (commands.length > 0) ***REMOVED***
        commands[commands.length - 1].args = args
  ***REMOVED***
      commands.push(***REMOVED*** name: arg, args: [] ***REMOVED***)
***REMOVED***
  ***REMOVED***, this)
  if (commands.length > 0) ***REMOVED***
    commands[commands.length - 1].args = argv.splice(0)
  ***REMOVED***

  // support for inheriting config env variables from npm
  var npm_config_prefix = 'npm_config_'
  Object.keys(process.env).forEach(function (name) ***REMOVED***
    if (name.indexOf(npm_config_prefix) !== 0) return
    var val = process.env[name]
    if (name === npm_config_prefix + 'loglevel') ***REMOVED***
      log.level = val
***REMOVED*** else ***REMOVED***
      // add the user-defined options to the config
      name = name.substring(npm_config_prefix.length)
      // gyp@741b7f1 enters an infinite loop when it encounters
      // zero-length options so ensure those don't get through.
      if (name) this.opts[name] = val
***REMOVED***
  ***REMOVED***, this)

  if (this.opts.loglevel) ***REMOVED***
    log.level = this.opts.loglevel
  ***REMOVED***
  log.resume()
***REMOVED***

/**
 * Spawns a child process and emits a 'spawn' event.
 */

proto.spawn = function spawn (command, args, opts) ***REMOVED***
  if (!opts) opts = ***REMOVED******REMOVED***
  if (!opts.silent && !opts.stdio) ***REMOVED***
    opts.stdio = [ 0, 1, 2 ]
  ***REMOVED***
  var cp = child_process.spawn(command, args, opts)
  log.info('spawn', command)
  log.info('spawn args', args)
  return cp
***REMOVED***

/**
 * Returns the usage instructions for node-gyp.
 */

proto.usage = function usage () ***REMOVED***
  var str = [
      ''
    , '  Usage: node-gyp <command> [options]'
    , ''
    , '  where <command> is one of:'
    , commands.map(function (c) ***REMOVED***
        return '    - ' + c + ' - ' + require('./' + c).usage
  ***REMOVED***).join('\n')
    , ''
    , 'node-gyp@' + this.version + '  ' + path.resolve(__dirname, '..')
    , 'node@' + process.versions.node
  ].join('\n')
  return str
***REMOVED***

/**
 * Version number getter.
 */

Object.defineProperty(proto, 'version', ***REMOVED***
    get: function () ***REMOVED***
      return this.package.version
***REMOVED***
  , enumerable: true
***REMOVED***)

