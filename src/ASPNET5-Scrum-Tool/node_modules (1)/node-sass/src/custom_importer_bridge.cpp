#include <nan.h>
#include <stdexcept>
#include "custom_importer_bridge.h"
#include "create_string.h"

SassImportList CustomImporterBridge::post_process_return_value(v8::Local<v8::Value> returned_value) const ***REMOVED***
  SassImportList imports = 0;
  Nan::HandleScope scope;

  if (returned_value->IsArray()) ***REMOVED***
    v8::Local<v8::Array> array = returned_value.As<v8::Array>();

    imports = sass_make_import_list(array->Length());

    for (size_t i = 0; i < array->Length(); ++i) ***REMOVED***
      v8::Local<v8::Value> value = Nan::Get(array, static_cast<uint32_t>(i)).ToLocalChecked();

      if (!value->IsObject()) ***REMOVED***
        auto entry = sass_make_import_entry(0, 0, 0);
        sass_import_set_error(entry, "returned array must only contain object literals", -1, -1);
        continue;
  ***REMOVED***

      v8::Local<v8::Object> object = value.As<v8::Object>();

      if (value->IsNativeError()) ***REMOVED***
        char* message = create_string(Nan::Get(object, Nan::New<v8::String>("message").ToLocalChecked()));

        imports[i] = sass_make_import_entry(0, 0, 0);

        sass_import_set_error(imports[i], message, -1, -1);
  ***REMOVED***
      else ***REMOVED***
        imports[i] = get_importer_entry(object);
  ***REMOVED***
***REMOVED***
  ***REMOVED***
  else if (returned_value->IsNativeError()) ***REMOVED***
    imports = sass_make_import_list(1);
    v8::Local<v8::Object> object = returned_value.As<v8::Object>();
    char* message = create_string(Nan::Get(object, Nan::New<v8::String>("message").ToLocalChecked()));

    imports[0] = sass_make_import_entry(0, 0, 0);

    sass_import_set_error(imports[0], message, -1, -1);
  ***REMOVED***
  else if (returned_value->IsObject()) ***REMOVED***
    imports = sass_make_import_list(1);
    imports[0] = get_importer_entry(returned_value.As<v8::Object>());
  ***REMOVED***

  return imports;
***REMOVED***

Sass_Import* CustomImporterBridge::check_returned_string(Nan::MaybeLocal<v8::Value> value, const char *msg) const
***REMOVED***
    v8::Local<v8::Value> checked;
    if (value.ToLocal(&checked)) ***REMOVED*** 
      if (!checked->IsUndefined() && !checked->IsString()) ***REMOVED***
        goto err;
  ***REMOVED*** else ***REMOVED***
        return nullptr;
  ***REMOVED*** 
***REMOVED***
err:
    auto entry = sass_make_import_entry(0, 0, 0);
    sass_import_set_error(entry, msg, -1, -1);
    return entry;
***REMOVED***

Sass_Import* CustomImporterBridge::get_importer_entry(const v8::Local<v8::Object>& object) const ***REMOVED***
  auto returned_file = Nan::Get(object, Nan::New<v8::String>("file").ToLocalChecked());
  auto returned_contents = Nan::Get(object, Nan::New<v8::String>("contents").ToLocalChecked()).ToLocalChecked();
  auto returned_map = Nan::Get(object, Nan::New<v8::String>("map").ToLocalChecked());
  Sass_Import *err;

  if ((err = check_returned_string(returned_file, "returned value of `file` must be a string")))
    return err;

  if ((err = check_returned_string(returned_contents, "returned value of `contents` must be a string")))
    return err;

  if ((err = check_returned_string(returned_map, "returned value of `returned_map` must be a string")))
    return err;

  char* path = create_string(returned_file);
  char* contents = create_string(returned_contents);
  char* srcmap = create_string(returned_map);

  return sass_make_import_entry(path, contents, srcmap);
***REMOVED***

std::vector<v8::Local<v8::Value>> CustomImporterBridge::pre_process_args(std::vector<void*> in) const ***REMOVED***
  std::vector<v8::Local<v8::Value>> out;

  for (void* ptr : in) ***REMOVED***
    out.push_back(Nan::New<v8::String>((char const*)ptr).ToLocalChecked());
  ***REMOVED***

  return out;
***REMOVED***
