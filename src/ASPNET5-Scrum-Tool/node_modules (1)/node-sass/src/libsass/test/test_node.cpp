#include <assert.h>
#include <sstream>

#include "node.hpp"
#include "to_string.hpp"
#include "parser.hpp"


#define STATIC_ARRAY_SIZE(array) (sizeof((array))/sizeof((array[0])))


namespace Sass ***REMOVED***

  Context ctx = Context::Data();

  To_String to_string;


  const char* const ROUNDTRIP_TESTS[] = ***REMOVED***
    NULL,
    "~",
    "CMPD",
    "~ CMPD",
    "CMPD >",
    "> > CMPD",
    "CMPD ~ ~",
    "> + CMPD1.CMPD2 > ~",
    "> + CMPD1.CMPD2 CMPD3.CMPD4 > ~",
    "+ CMPD1 CMPD2 ~ CMPD3 + CMPD4 > CMPD5 > ~"
  ***REMOVED***;



  static Complex_Selector* createComplexSelector(std::string src) ***REMOVED***
    std::string temp(src);
    temp += ";";
    return (*Parser::from_c_str(temp.c_str(), ctx, "", Position()).parse_selector_list())[0];
  ***REMOVED***


  void roundtripTest(const char* toTest) ***REMOVED***

    // Create the initial selector

    Complex_Selector* pOrigSelector = NULL;
    if (toTest) ***REMOVED***
      pOrigSelector = createComplexSelector(toTest);
***REMOVED***

    std::string expected(pOrigSelector ? pOrigSelector->perform(&to_string) : "NULL");


    // Roundtrip the selector into a node and back

    Node node = complexSelectorToNode(pOrigSelector, ctx);

    std::stringstream nodeStringStream;
    nodeStringStream << node;
    std::string nodeString = nodeStringStream.str();
    cout << "ASNODE: " << node << endl;

    Complex_Selector* pNewSelector = nodeToComplexSelector(node, ctx);

    // Show the result

    std::string result(pNewSelector ? pNewSelector->perform(&to_string) : "NULL");

    cout << "SELECTOR: " << expected << endl;
    cout << "NEW SELECTOR:   " << result << endl;


    // Test that they are equal using the equality operator

    assert( (!pOrigSelector && !pNewSelector ) || (pOrigSelector && pNewSelector) );
    if (pOrigSelector) ***REMOVED***
      assert( *pOrigSelector == *pNewSelector );
***REMOVED***


    // Test that they are equal by comparing the string versions of the selectors

    assert(expected == result);

  ***REMOVED***


  int main() ***REMOVED***
    for (int index = 0; index < STATIC_ARRAY_SIZE(ROUNDTRIP_TESTS); index++) ***REMOVED***
      const char* const toTest = ROUNDTRIP_TESTS[index];
      cout << "\nINPUT STRING: " << (toTest ? toTest : "NULL") << endl;
      roundtripTest(toTest);
***REMOVED***

    cout << "\nTesting Done.\n";
  ***REMOVED***


***REMOVED***
